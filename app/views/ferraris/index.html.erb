<script type="text/javascript" charset="utf-8">
        var years = <%= raw @years %>;
</script>

<div class="row">
    <div class="span12 header-forsale">
        <div id="title">
            Ferraris For Sale
        </div>
        <div id="description">
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.
        </div>
        <div id="query">
            <div id="forsale-query-title">
                Search For:
            </div>
            <div id="filter-year">
                <input type="text" name="year-fr" value="Year Fr" id="year-fr" class="fromto"> 
                <input type="text" name="year-to" value="Year To" id="year-to" class="fromto">
                
                <input type="hidden" name="year-fr-h" value="" id="year-fr-h"> 
                <input type="hidden" name="year-to-h" value="" id="year-to-h">
            </div>
            <div id="filter-model">
                <input type="text" name="model" value="Model" id="model"><a href="#" id='dropdown-models'><i class="icon-chevron_down"></i></a>
                <input type="hidden" name="model-h" value="model-h" id="model-h">
            </div>
            <div id="filter-price">
                <input type="text" name="price-fr" value="Price Fr" id="price-fr" class="fromto"> <input type="text" name="price-to" value="Price To" id="price-to" class="fromto">
            </div>
            <div id="filter-keywords">
                <input type="text" name="keywords" value="Keywords" id="keywords">
            </div>            
            <div id="submit">
                <input type="submit" name="submit" value="Filter" id="submit">
            </div>
            <div id="errorMessage" style="display:none;">
                IMPORTANT: From should be less than To.
            </div>
        </div>
    </div>
</div>

<%= will_paginate %>

<%= render 'ferraris/list' %>

<%= will_paginate %>

<script type="text/javascript" charset="utf-8">
    // Handler for .ready() called.
      $("#year-fr").on("focus", function(e) {
          if(e.currentTarget.value == "Year Fr")
              e.currentTarget.value = "";
      })
      $("#year-fr").on("blur", function(e) {
          if(e.currentTarget.value == "")
            e.currentTarget.value = "Year Fr";
      })

      $("#year-to").on("focus", function(e) {
          if(e.currentTarget.value == "Year To")
              e.currentTarget.value = "";
      })
      $("#year-to").on("blur", function(e) {
          if(e.currentTarget.value == "")
            e.currentTarget.value = "Year To";
      })

      //PRICE
      $("#price-fr").on("focus", function(e) {
          if(e.currentTarget.value == "Price Fr")
              e.currentTarget.value = "";
      })
      $("#price-fr").on("blur", function(e) {
            if(e.currentTarget.value == "")
                e.currentTarget.value = "Price Fr";
      })
      $("#price-to").on("focus", function(e) {
          if(e.currentTarget.value == "Price To")
              e.currentTarget.value = "";
      })
      $("#price-to").on("blur", function(e) {
          if(e.currentTarget.value == "")
              e.currentTarget.value = "Price To";
      })

      //KEYWORDS
      $("#keywords").on("focus", function(e) {
            if(e.currentTarget.value == "Keywords")
                e.currentTarget.value = "";
      })
      $("#keywords").on("blur", function(e) {
              if(e.currentTarget.value == "")
                  e.currentTarget.value = "Keywords";
      })

      $("#dropdown-models").on("click", function(){
          console.log("dropdown-models click")
          $("#model").autocomplete("search", "");
      });

      $("#year-fr").autocomplete({
          /* snip */
          source: years,
          select: function(event, ui) {
              event.preventDefault();
              $("#year-fr").val(ui.item.label);
              $("#year-fr-h").val(ui.item.id);
          },
          focus: function(event, ui) {
              event.preventDefault();
              $("#year-fr").val(ui.item.label);
          }
      });


      $("#year-to").autocomplete({
          /* snip */
          source: years,
          select: function(event, ui) {
              event.preventDefault();
              $("#year-to").val(ui.item.label);
              $("#year-to-h").val(ui.item.id);
          },
          focus: function(event, ui) {
              event.preventDefault();
              $("#year-to").val(ui.item.label);
          }
      });

      var checkAndFilterModels = function(e) {
          var syea_fr = $("#year-fr").attr("value"),
              syea_to = $("#year-to").attr("value");

          var year_fr = Number($("#year-fr").attr("value")),
              year_to = Number($("#year-to").attr("value"));

          var blank_fr = (syea_fr == "" || syea_fr == "Year Fr")? true : false;
          var blank_to = (syea_to == "" || syea_to == "Year To")? true : false;

          if((year_fr >= Number(years[0].label) && year_fr <= year_to && year_to <= Number(years[years.length-1].label)) ||
              ((blank_fr && !blank_to) && year_to <= Number(years[years.length-1].label)) ||
              ((blank_to && !blank_fr) && year_fr >= Number(years[0].label))
          ) {
              $("#errorMessage").css("display", "none");
              e.preventDefault();
              $.ajax({
                type: "POST",
                url: "/filter_car_models",
                data: { year_fr: $("#year-fr").attr("value"), year_to: $("#year-to").attr("value") }
              })
                .done(function(response) {
                    $("#model").autocomplete({
                        /* snip */
                            minLength: 0,
                            source: response,
                            select: function(event, ui) {
                                event.preventDefault();
                                $("#model").val(ui.item.label);
                                $("#model-h").val(ui.item.id);
                            },
                            focus: function(event, ui) {
                                event.preventDefault();
                                $("#model").val(ui.item.label);
                            }
                    });
              });
          } else {
              $("#errorMessage").css("display", "block");
          }
      }

      $("#year-fr").on("blur", checkAndFilterModels);
      $("#year-to").on("blur", checkAndFilterModels);
</script>